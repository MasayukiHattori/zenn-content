---
title: "Blazor Web App + ASP.NET Core Identity ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ã¨èªå¯ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸš¥"
type: "tech"
topics:
  - "csharp"
  - "blazor"
  - "authentication"
  - "aspnetcore"
  - "authorization"
published: true
published_at: "2024-04-14 00:00"
---

# æ¦‚è¦
Blazor Web Appãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èªè¨¼ã‚ã‚Šã§ä½œæˆã—ãŸå¾Œã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å†…å®¹ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’è¡Œã„ã¾ã™ã€‚

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’PostgreSQLã«å¤‰æ›´ã—ã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã«å¾“æ¥­å“¡IDã¨æ°åã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ ã‚‚ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- ç™»éŒ²ã—ãŸæ°åã‚’Blazorã®ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- å¾“æ¥­å“¡IDã‚’ä½¿ç”¨ã—ãŸãƒãƒªã‚·ãƒ¼ãƒ™ãƒ¼ã‚¹ã®èªå¯ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

## é–‹ç™ºç’°å¢ƒ
- .NET 8.0
- Microsoft Visual Studio 2022 Community (64ãƒ“ãƒƒãƒˆ) Version 17.9.1
- C# 12.0
- Windows 11 Pro 24H2
- PostgreSQL 15.3
- Npgsql.EntityFrameworkCore.PostgreSQL 8.0.2

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
èªè¨¼ã®ç¨®é¡ã‚’å€‹åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã—ã¦Blazor Web Appã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯`IdentityDemo`ã«ã—ã¾ã—ãŸã€‚

- ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼šIdentityDemo
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼šIdentityDemo.Client

![Blazor Web Appã®ä½œæˆ](https://storage.googleapis.com/zenn-user-upload/7c3a72197fec-20240412.png)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’PostgreSQLã«å¤‰æ›´ã™ã‚‹
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½œæˆã•ã‚Œã¦ã„ã‚‹Migrationã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```powershell:.NET CLI
Remove-Migration
```

NuGetã‹ã‚‰`Npgsql.EntityframeworkCore.PostgreSQL`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
![Npgsql.EntityframeworkCore.PostgreSQL](https://storage.googleapis.com/zenn-user-upload/1c70985c9a47-20240412.png)

PostgreSQLã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ç‚ºã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã®æƒ…å ±ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ç®¡ç†ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
```powershell:.NET CLI
dotnet user-secrets init
```
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç®¡ç†`ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ã€‚
```json
{
  "Db:Username": "postgres",
  "Db:Password": "{ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰}",
  "Db:Host": "localhost",
  "Db:Database": "IdentityDemo"
}
```

ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`Program.cs`ã‚’å¤‰æ›´ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```diff dotnet:Program.cs
using IdentityDemo.Client.Pages;
using IdentityDemo.Components;
using IdentityDemo.Components.Account;
using IdentityDemo.Data;
using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
+ using Npgsql;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents()
    .AddInteractiveWebAssemblyComponents();

builder.Services.AddCascadingAuthenticationState();
builder.Services.AddScoped<IdentityUserAccessor>();
builder.Services.AddScoped<IdentityRedirectManager>();
builder.Services.AddScoped<AuthenticationStateProvider, PersistingRevalidatingAuthenticationStateProvider>();

builder.Services.AddAuthentication(options =>
    {
        options.DefaultScheme = IdentityConstants.ApplicationScheme;
        options.DefaultSignInScheme = IdentityConstants.ExternalScheme;
    })
    .AddIdentityCookies();

- var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
- builder.Services.AddDbContext<ApplicationDbContext>(options =>
-     options.UseSqlServer(connectionString));
+ var connStringBuilder = new NpgsqlConnectionStringBuilder
+ {
+     Host = builder.Configuration["Db:Host"],
+     Username = builder.Configuration["Db:Username"],
+     Password = builder.Configuration["Db:Password"],
+     Database = builder.Configuration["Db:Database"]
+ };
var connectionString = connStringBuilder.ToString();
builder.Services.AddDbContext<ApplicationDbContext>(options =>
options.UseNpgsql(connectionString, o => o.UseQuerySplittingBehavior(QuerySplittingBehavior.SplitQuery)));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddIdentityCore<ApplicationUser>(options => options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddSignInManager()
    .AddDefaultTokenProviders();

builder.Services.AddSingleton<IEmailSender<ApplicationUser>, IdentityNoOpEmailSender>();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseWebAssemblyDebugging();
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();

app.UseStaticFiles();
app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode()
    .AddInteractiveWebAssemblyRenderMode()
    .AddAdditionalAssemblies(typeof(IdentityDemo.Client._Imports).Assembly);

// Add additional endpoints required by the Identity /Account Razor components.
app.MapAdditionalIdentityEndpoints();

app.Run();

```

ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`Data`ãƒ•ã‚©ãƒ«ãƒ€ã«`IDesignTimeDbContextFactory`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ãŸ`ApplicationDbContextFactory`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚Entity Framework Coreã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (PMC) ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã«æœ¬ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ã‚¯ãƒ©ã‚¹ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```dotnet:ApplicationDbContextFactory.cs
using Microsoft.EntityFrameworkCore.Design;
using Microsoft.EntityFrameworkCore;
using Npgsql;

namespace IdentityDemo.Data
{
    public class ApplicationDbContextFactory : IDesignTimeDbContextFactory<ApplicationDbContext>
    {
        public ApplicationDbContext CreateDbContext(string[] args)
        {
            //ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹
            var configuration = new ConfigurationBuilder()
                .AddUserSecrets<ApplicationDbContextFactory>()
                .Build();

            //DBæ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—ã™ã‚‹
            var connStringBuilder = new NpgsqlConnectionStringBuilder
            {
                Host = configuration["Db:Host"],
                Username = configuration["Db:Username"],
                Password = configuration["Db:Password"],
                Database = configuration["Db:Database"]
            };

            var optionBuilder = new DbContextOptionsBuilder<ApplicationDbContext>();
            optionBuilder.UseNpgsql(connStringBuilder.ConnectionString);

            return new ApplicationDbContext(optionBuilder.Options);
        }
    }
}
```

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚
```powershell
Add-Migration InitialCreate
Update-Database
```

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã«å¾“æ¥­å“¡IDã€æ°åã‚’è¿½åŠ ã™ã‚‹
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã‚’å¤‰æ›´ã—ã¦å¾“æ¥­å“¡IDã€æ°åã‚’ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`Components/Account/Pages/Register.razor`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

`InputModel`ã‚¯ãƒ©ã‚¹ã«å¾“æ¥­å“¡IDï¼ˆ`EmployeeID`ï¼‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨æ°åï¼ˆ`FullName`ï¼‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff dotnet:Register.razor
    private sealed class InputModel
    {
+        [Required]
+        [Display(Name = "EmployeeID")]
+        public string EmployeeID { get; set; } = "";

+        [Required]
+        [Display(Name = "Full Name")]
+        public string FullName { get; set; } = "";

        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
```

å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«å¾“æ¥­å“¡IDã¨æ°åã®å…¥åŠ›æ¬„ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff razor:Register.razor
+            <div class="form-floating mb-3">
+                <InputText @bind-Value="Input.EmployeeID" class="form-control" autocomplete="off" aria-required="true" placeholder="Please enter your employee id." />
+                <label for="employeeId">Employee ID</label>
+                <ValidationMessage For="() => Input.EmployeeID" class="text-danger" />
+            </div>
+            <div class="form-floating mb-3">
+                <InputText @bind-Value="Input.FullName" class="form-control" autocomplete="name" aria-required="true" placeholder="Please enter your full name." />
+                <label for="fullName">Name</label>
+                <ValidationMessage For="() => Input.FullName" class="text-danger" />
+            </div>
```

`RegisterUser`ãƒ¡ã‚½ãƒƒãƒ‰ã«å¾“æ¥­å“¡IDã¨æ°åã®`Claim`ã‚’ç™»éŒ²ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff dotnet:Register.razor
    public async Task RegisterUser(EditContext editContext)
    {
        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        var emailStore = GetEmailStore();
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            identityErrors = result.Errors;
            return;
        }

        Logger.LogInformation("User created a new account with password.");

+        result = await UserManager.AddClaimsAsync(user,
+            new[]
+            {
+                new Claim("employeeID",Input.EmployeeID),
+                new Claim("fullName",Input.FullName),
+                    });

+        if (!result.Succeeded)
+        {
+            identityErrors = result.Errors;
+            return;
+        }

+        Logger.LogInformation("UserCrames created.");

ä»¥ä¸‹çœç•¥
    }
```

ã“ã‚Œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã«å¾“æ¥­å“¡IDã¨æ°åã‚’è¿½åŠ ã§ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`Register.razor`ã¯ä¸‹è¨˜ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚
```diff razor:Register.razor
@page "/Account/Register"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using IdentityDemo.Data
@using System.Security.Claims

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject ILogger<Register> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Register</PageTitle>

<h1>Register</h1>

<div class="row">
    <div class="col-md-4">
        <StatusMessage Message="@Message" />
        <EditForm Model="Input" asp-route-returnUrl="@ReturnUrl" method="post" OnValidSubmit="RegisterUser" FormName="register">
            <DataAnnotationsValidator />
            <h2>Create a new account.</h2>
            <hr />
            <ValidationSummary class="text-danger" role="alert" />
+            <div class="form-floating mb-3">
+                <InputText @bind-Value="Input.EmployeeID" class="form-control" autocomplete="off" aria-required="true" placeholder="Please enter your employee id." />
+                <label for="employeeId">Employee ID</label>
+                <ValidationMessage For="() => Input.EmployeeID" class="text-danger" />
+            </div>
+            <div class="form-floating mb-3">
+                <InputText @bind-Value="Input.FullName" class="form-control" autocomplete="name" aria-required="true" placeholder="Please enter your full name." />
+                <label for="fullName">Name</label>
+                <ValidationMessage For="() => Input.FullName" class="text-danger" />
+            </div>
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                <label for="email">Email</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label for="password">Password</label>
                <ValidationMessage For="() => Input.Password" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label for="confirm-password">Confirm Password</label>
                <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Register</button>
        </EditForm>
    </div>
    <div class="col-md-6 col-md-offset-2">
        <section>
            <h3>Use another service to register.</h3>
            <hr />
            <ExternalLoginPicker />
        </section>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    public async Task RegisterUser(EditContext editContext)
    {
        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        var emailStore = GetEmailStore();
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            identityErrors = result.Errors;
            return;
        }

        Logger.LogInformation("User created a new account with password.");

+        result = await UserManager.AddClaimsAsync(user,
+            new[]
+            {
+                new Claim("employeeID",Input.EmployeeID),
+                new Claim("fullName",Input.FullName),
+                    });

+        if (!result.Succeeded)
+        {
+            identityErrors = result.Errors;
+            return;
+        }

+        Logger.LogInformation("UserCrames created.");


        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });

        await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        if (UserManager.Options.SignIn.RequireConfirmedAccount)
        {
            RedirectManager.RedirectTo(
                "Account/RegisterConfirmation",
                new() { ["email"] = Input.Email, ["returnUrl"] = ReturnUrl });
        }

        await SignInManager.SignInAsync(user, isPersistent: false);
        RedirectManager.RedirectTo(ReturnUrl);
    }

    private ApplicationUser CreateUser()
    {
        try
        {
            return Activator.CreateInstance<ApplicationUser>();
        }
        catch
        {
            throw new InvalidOperationException($"Can't create an instance of '{nameof(ApplicationUser)}'. " +
                $"Ensure that '{nameof(ApplicationUser)}' is not an abstract class and has a parameterless constructor.");
        }
    }

    private IUserEmailStore<ApplicationUser> GetEmailStore()
    {
        if (!UserManager.SupportsUserEmail)
        {
            throw new NotSupportedException("The default UI requires a user store with email support.");
        }
        return (IUserEmailStore<ApplicationUser>)UserStore;
    }

    private sealed class InputModel
    {
+        [Required]
+        [Display(Name = "EmployeeID")]
+        public string EmployeeID { get; set; } = "";

+        [Required]
+        [Display(Name = "Full Name")]
+        public string FullName { get; set; } = "";

        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
```

# AuthenticationStateã‹ã‚‰å¾“æ¥­å“¡IDã€æ°åã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
èªè¨¼æƒ…å ±ã«é …ç›®ã‚’è¿½åŠ ã™ã‚‹æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
1. èªè¨¼æƒ…å ±ã®å—ã‘çš¿ã¨ãªã‚‹`UserInfo`ã‚¯ãƒ©ã‚¹ã«å¾“æ¥­å“¡IDã€æ°åã‚’è¿½åŠ ã—ã¾ã™ã€‚
2. ã‚µãƒ¼ãƒãƒ¼å´ã®èªè¨¼çŠ¶æ…‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã‚ã‚‹`PersistingRevalidatingAuthenticationStateProvider`ã‚¯ãƒ©ã‚¹ã«ã‚ã‚‹`OnPersistingAsync`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¤‰æ›´ã—ã¦`Claim`ã‹ã‚‰å¾“æ¥­å“¡IDã¨æ°åã‚’`UserInfo`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®èªè¨¼çŠ¶æ…‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼`PersistentAuthenticationStateProvider`ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«`PersistentComponentState`ï¼ˆæ°¸ç¶šçš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçŠ¶æ…‹ï¼‰ã¨ã—ã¦èªè¨¼æƒ…å ±`UserInfo`ãŒã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã¾ã™ã®ã§ã€ã“ã“ã§å¾“æ¥­å“¡IDã¨æ°åã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
èªè¨¼çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯å…¬å¼ã‚µã‚¤ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://learn.microsoft.com/ja-jp/aspnet/core/blazor/security/server/?view=aspnetcore-8.0&tabs=visual-studio#manage-authentication-state-in-blazor-web-apps

https://learn.microsoft.com/ja-jp/aspnet/core/blazor/components/prerender?view=aspnetcore-8.0#persist-prerendered-state

ã¾ãšã€èªè¨¼æƒ…å ±ã®å—ã‘çš¿ã¨ãªã‚‹`UserInfo`ã‚¯ãƒ©ã‚¹ã«å¾“æ¥­å“¡IDã¨æ°åã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`UserInfo.cs`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
```diff dotnet:UserInfo.cs
namespace IdentityDemo.Client
{
    // Add properties to this class and update the server and client AuthenticationStateProviders
    // to expose more information about the authenticated user to the client.
    public class UserInfo
    {
        public required string UserId { get; set; }
        public required string Email { get; set; }
+        public required string EmployeeId { get; set; }
+        public required string FullName { get; set; }
    }
}
```

ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`PersistingRevalidatingAuthenticationStateProvider`ã«ã‚ã‚‹`OnPersistingAsync`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¤‰æ›´ã—ã¦å¾“æ¥­å“¡IDã¨æ°åã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’èªè¨¼æƒ…å ±`UserInfo`ã«åŠ ãˆã‚‹ã‚ˆã†ã«ã¾ã™ã€‚ã“ã‚Œã§ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯`AuthenticationState`ã‹ã‚‰å¾“æ¥­å“¡IDã¨æ°åã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```diff dotnet:PersistingRevalidatingAuthenticationStateProvider.cs
        private async Task OnPersistingAsync()
        {
            if (authenticationStateTask is null)
            {
                throw new UnreachableException($"Authentication state not set in {nameof(OnPersistingAsync)}().");
            }

            var authenticationState = await authenticationStateTask;
            var principal = authenticationState.User;

            if (principal.Identity?.IsAuthenticated == true)
            {
                var userId = principal.FindFirst(options.ClaimsIdentity.UserIdClaimType)?.Value;
                var email = principal.FindFirst(options.ClaimsIdentity.EmailClaimType)?.Value;
+                var employeeId = principal.FindFirst("employeeID")?.Value;
+                var fullName = principal.FindFirst("fullName")?.Value;

-                if (userId != null && email != null)
+                if (userId != null && email != null && employeeId != null && fullName != null)
                {
                    state.PersistAsJson(nameof(UserInfo), new UserInfo
                    {
                        UserId = userId,
                        Email = email,
+                        EmployeeId = employeeId,
+                        FullName = fullName
                    });
                }
            }
        }
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`PersistentAuthenticationStateProvider`ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å¤‰æ›´ã—ã¦å¾“æ¥­å“¡IDã¨æ°åã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’èªè¨¼æƒ…å ±`UserInfo`ã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚`AuthenticationState`ã‹ã‚‰å¾“æ¥­å“¡IDã¨æ°åã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```diff dotnet:PersistentAuthenticationStateProvider.cs
        public PersistentAuthenticationStateProvider(PersistentComponentState state)
        {
            if (!state.TryTakeFromJson<UserInfo>(nameof(UserInfo), out var userInfo) || userInfo is null)
            {
                return;
            }

            Claim[] claims = [
                new Claim(ClaimTypes.NameIdentifier, userInfo.UserId),
                new Claim(ClaimTypes.Name, userInfo.Email),
                new Claim(ClaimTypes.Email, userInfo.Email),
+                new Claim("employeeID", userInfo.EmployeeId),
+                new Claim("fullName", userInfo.FullName)];

            authenticationStateTask = Task.FromResult(
                new AuthenticationState(new ClaimsPrincipal(new ClaimsIdentity(claims,
                    authenticationType: nameof(PersistentAuthenticationStateProvider)))));
        }
```

`ClaimsPrincipal`ã®æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦è¿½åŠ ã—ãŸã‚¯ãƒ¬ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ãã—ã¾ã™ã€‚
```dotnet:ClaimsPrincipalExtensions.cs
using System.Security.Claims;

namespace IdentityDemo.Client.Authentication
{
    public static class ClaimsPrincipalExtensions
    {
        public static string GetCustomClaim(this ClaimsPrincipal principal, string type)
        {
            if (principal == null)
                throw new ArgumentNullException(nameof(principal));

            return principal.Claims
                .Where(x => x.Type == type)
                .Select(x => x.Value)
                .FirstOrDefault()!;
        }

        public static string GetUserName(this ClaimsPrincipal principal)
            => principal.GetCustomClaim("employeeID");

        public static string GetFullName(this ClaimsPrincipal principal)
            => principal.GetCustomClaim("fullName");
    }
}
```


# æ°åã‚’ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹
ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ°åã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`NavMenu`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã€æ°åã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff razor:NavMenu.razor
+ @using IdentityDemo.Client.Authentication

ä¸­ç•¥...

            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Manage">
-                        <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span> @context.User.Identity?.Name
+                        <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span> @context.User.GetFullName()
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <button type="submit" class="nav-link">
                            <span class="bi bi-arrow-bar-left-nav-menu" aria-hidden="true"></span> Logout
                        </button>
                    </form>
                </div>
            </Authorized>
```

æ¬¡ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ°åã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`Counter`ãƒšãƒ¼ã‚¸ã«æ°åã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```diff razor:Counter.razor
+ <AuthorizeView>
+    <Authorized>
+        <p>Hello! @context.User.GetFullName()</p>
+    </Authorized>
+ </AuthorizeView>
```

# ãƒãƒªã‚·ãƒ¼ ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ  ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ï¼‰ã‚’å®Ÿè£…ã™ã‚‹
å¾“æ¥­å“¡IDãŒ"1","2","3"ã®ã„ãšã‚Œã‹ã«ä¸€è‡´ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¦ã€`Counter`ãƒšãƒ¼ã‚¸ã«ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã—ã¾ã™ã€‚
ã‚µãƒ¼ãƒãƒ¼å´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®`Program.cs`ã«`MyPolicy`ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚æ‰¿èªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ§‹æˆã™ã‚‹`AddAuthorizationCore`ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰ãƒãƒªã‚·ãƒ¼ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚
```dotnet:Program.cs
builder.Services.AddAuthorizationCore(options =>
{
    options.AddPolicy("MyPolicy", policy => policy.RequireClaim("employeeID", "1", "2", "3"));
});
```

`Counter`ãƒšãƒ¼ã‚¸ã‚’å¤‰æ›´ã—ã¦ãƒãƒªã‚·ãƒ¼ã‚’æº€ãŸã™å ´åˆã®ã¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```razor:Counter.razor
<AuthorizeView Policy="MyPolicy">
    <Authorized>
        <p role="status">Current count: @currentCount</p>

        <button class="btn btn-primary" @onclick="IncrementCount">Click me</button>
    </Authorized>
</AuthorizeView>
```
# å‹•ä½œç¢ºèªã‚’ã™ã‚‹
ã“ã“ã¾ã§å®Ÿè£…å‡ºæ¥ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
ã¾ãšã€å¾“æ¥­å“¡IDãŒ"1"ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
![å¾“æ¥­å“¡IDãŒ"1"ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²](https://storage.googleapis.com/zenn-user-upload/d13c5c551c93-20240413.png)


`Click here to confirm your account`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ¸ˆã¿ã«ã—ã¾ã™ã€‚
![ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹](https://storage.googleapis.com/zenn-user-upload/2dcdd5581354-20240413.png)


ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€å·¦å´ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«æ°åãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚
![å·¦å´ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«æ°åãŒè¡¨ç¤ºã•ã‚Œã‚‹](https://storage.googleapis.com/zenn-user-upload/6f4f56ab06f2-20240413.png)


Counterãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ã¨åŒæ§˜ã«æ°åãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¾ãŸã€å¾“æ¥­å“¡IDãŒ"1"ã§ã‚ã‚‹ãŸã‚ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
![Counterãƒšãƒ¼ã‚¸ã«æ°åã¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹](https://storage.googleapis.com/zenn-user-upload/74c08e83941d-20240413.png)


ä»Šåº¦ã¯å¾“æ¥­å“¡IDãŒ"99"ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰å‹•ä½œç¢ºèªã‚’ã—ã¾ã™ã€‚
![å¾“æ¥­å“¡IDãŒ"99"ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹](https://storage.googleapis.com/zenn-user-upload/2c1154e580b9-20240413.png)

Counterãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ã¨æ°åã¯è¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€å¾“æ¥­å“¡IDãŒ`MyPolicy`ãƒãƒªã‚·ãƒ¼ã«åˆè‡´ã—ãªã„ãŸã‚ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
![](https://storage.googleapis.com/zenn-user-upload/0f9ec3e0f62f-20240413.png)

GitHubã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¾ã™ã€‚å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
https://github.com/MasayukiHattori/IdentityDemo